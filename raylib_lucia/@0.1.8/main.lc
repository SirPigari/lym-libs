import libload
import os
import fs

// Raylib binding for Lucia
// This library supports Windows, Linux, and macOS platforms.

// Currently in development. Only a subset of functions are implemented.

public final RAYLIB_VERSION: str = "5.5.0"
public final RAYLIB_LUCIA_VERSION: str = "0.1.8"

private mutable lib: ?&int = null
private mutable lib_bind: ?&int = null

match (os.os_name()):
    "Windows":
        if (!fs.file_exists(__dir__ + "lib/raylib.dll")):
            throw f"raylib.dll not found in {__dir__ + 'lib/'}." from "FileNotFoundError"
        end
        if (!fs.file_exists(__dir__ + "lib/raylib_lucia.dll")):
            throw f"raylib_lucia.dll not found in {__dir__ + 'lib/'}." from "FileNotFoundError"
        end
        libload.set_dll_directory(__dir__ + "lib/")
        lib = libload.load_lib(__dir__ + "lib/raylib.dll")
        lib_bind = libload.load_lib(__dir__ + "lib/raylib_lucia.dll")
    end
    "Linux":
        if (!fs.file_exists(__dir__ + "lib/raylib.so")):
            throw f"raylib.so not found in {__dir__ + 'lib/'}." from "FileNotFoundError"
        end
        if (!fs.file_exists(__dir__ + "lib/raylib_lucia.so")):
            throw f"raylib_lucia.so not found in {__dir__ + 'lib/'}." from "FileNotFoundError"
        end
        lib = libload.load_lib(__dir__ + "lib/raylib.so", flags=libload.RTLD_LAZY | libload.RTLD_GLOBAL)
        lib_bind = libload.load_lib(__dir__ + "lib/raylib_lucia.so")
    end
    "Darwin":
        if (!fs.file_exists(__dir__ + "lib/raylib.dylib")):
            throw f"raylib.dylib not found in {__dir__ + 'lib/'}." from "FileNotFoundError"
        end
        if (!fs.file_exists(__dir__ + "lib/raylib_lucia.dylib")):
            throw f"raylib_lucia.dylib not found in {__dir__ + 'lib/'}." from "FileNotFoundError"
        end
        lib = libload.load_lib(__dir__ + "lib/raylib.dylib", flags=libload.RTLD_LAZY | libload.RTLD_GLOBAL)
        lib_bind = libload.load_lib(__dir__ + "lib/raylib_lucia.dylib")
    end
    _ ->
        throw f"Unsupported OS: {os.os_name()}" from "UnsupportedOSError"
    end
end

if (lib == null):
    throw "Failed to load the raylib library." from "LibraryLoadError"
end

// Include all definition files
#include "defs/core.lc"
#include "defs/window.lc"
#include "defs/text.lc"
#include "defs/drawing.lc"
#include "defs/input.lc"
#include "defs/audio.lc"
#include "defs/colors.lc"
#include "defs/image.lc"

// Clean up
lib = libload.unload_lib(lib)
lib_bind = libload.unload_lib(lib_bind)
